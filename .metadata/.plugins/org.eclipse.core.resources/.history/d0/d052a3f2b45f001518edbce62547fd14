package click.rmx.engine.geometry;

import java.nio.Buffer;
import java.nio.ByteBuffer;
import java.nio.FloatBuffer;
import java.nio.ShortBuffer;

import org.lwjgl.BufferUtils;
import org.lwjgl.opengl.ARBVertexAttribBinding;

import static org.lwjgl.system.MemoryUtil.memAddress;
public interface Shape {
	float[] vertices();
	float[] normals();
	short[] indices();
	
	default int vertexSize() {
		return this.vertices().length;
	}
	
	default int normalsSize() {
		return this.normals().length;
	}
	
	default int indexSize() {
		return this.indices().length;
	}
	
	default void initBuffers() {
		FloatBuffer vBuffer = getVertexBuffer() != null 
				? getVertexBuffer()
				: BufferUtils.createFloatBuffer(this.vertexSize());
		FloatBuffer nBuffer = getNormalsBuffer() != null
				? getNormalsBuffer()
				: BufferUtils.createFloatBuffer(this.normalsSize());
		ByteBuffer iBuffer = getIndexBuffer() != null
				? getIndexBuffer()
				: BufferUtils.createByteBuffer(this.indexSize());
		vBuffer.put(this.vertices());
		for (short i : this.indices())
			this.getIndexBuffer().putInt(i);
		this.getNormalsBuffer().put(this.normals());
		
		vBuffer.flip();
		nBuffer.flip();
		iBuffer.flip();
		
		this.setVertexBuffer(vBuffer);
		this.setNormalsBuffer(nBuffer);
		this.setIndexBuffer(iBuffer);
	}
	
	/**
	 * Called but initBuffers 
	 * @param buffer
	 */
	void setVertexBuffer(Buffer buffer);
	
	/**
	 * Called but initBuffers 
	 * @param buffer
	 */
	void setIndexBuffer(Buffer buffer);
	
	/**
	 * Called but initBuffers 
	 * @param buffer
	 */
	void setNormalsBuffer(Buffer buffer);
	
	FloatBuffer getVertexBuffer();
	
	ByteBuffer getIndexBuffer();
	
	FloatBuffer getNormalsBuffer();
	
	default long vertexBufferPointer() {
		return memAddress(getVertexBuffer());
	}
	
	default long normalsBufferPointer() {
		return memAddress(getNormalsBuffer());
	}
	
	default long indexBufferPointer() {
		return memAddress(getIndexBuffer());
	}
	default void bindToBuffer(int buffer) {
		System.err.println("Not tested or safe");
		System.exit(-1);
		 ARBVertexAttribBinding.glBindVertexBuffer(
				 (int) this.vertexBufferPointer(),
				 buffer,
				 0,
				 4
		    );
		 ARBVertexAttribBinding.glBindVertexBuffer(
				 (int) this.normalsBufferPointer(),
				 buffer,
				 0,
				 4
		    );
		 ARBVertexAttribBinding.glBindVertexBuffer(
				 (int) this.indexBufferPointer(),
				 buffer,
				 0,
				 1
		    );
	}
	
}



